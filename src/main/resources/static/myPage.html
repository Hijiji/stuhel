<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <title>Welcome! Stuhel's home</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Bootstrap Icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Merriweather+Sans:400,700" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic" rel="stylesheet" type="text/css" />
    <!-- SimpleLightbox plugin CSS-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/SimpleLightbox/2.1.0/simpleLightbox.min.css" rel="stylesheet" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">    <!-- flatpicker css -->
    <script src="https://npmcdn.com/flatpickr/dist/flatpickr.min.js"></script>    <!-- flatpicker min js -->
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>          <!-- flatpicker ko -->
    <!--sweet alert-->
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <style>

.modal-wrapper {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-new {
  background: white;
  padding: 24px 16px;
  border-radius: 4px;
  width: 320px;
}

.modal-title {
  font-size: 24px;
  font-weight: bold;
}

.modal p {
  font-size: 16px;
}

.close-wrapper {
  text-align: right;
}
    </style>
</head>

<body id="page-top">

<script>

</script>
<!-- Navigation-->
<nav class="navbar navbar-expand-lg navbar-light fixed-top py-3" id="mainNav">
    <div class="container px-4 px-lg-5">
        <a class="navbar-brand" href="#page-top">Start Bootstrap</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ms-auto my-2 my-lg-0">
                <li class="nav-item"><a class="nav-link" href="#about">About</a></li>
                <li class="nav-item"><a class="nav-link" href="#myInfo">회원정보</a></li>
                <li class="nav-item"><a class="nav-link" href="#bookStatus">예약현황</a></li>
                <li class="nav-item"><a class="nav-link" href="#portfolio">Portfolio</a></li>
                <li class="nav-item"><a class="nav-link" onclick="logoutButton()">logout</a></li>
            </ul>
        </div>
    </div>
</nav>
<!-- Masthead-->
<header class="masthead" id="about">
    <div class="container px-4 px-lg-5 h-100">
        <div class="row gx-4 gx-lg-5 h-100 align-items-center justify-content-center text-center">
            <div class="col-lg-8 align-self-center">
                <h1 class="text-white font-weight-bold">MY PAGE</h1>
                <hr class="divider" />
            </div>
        </div>
    </div>
</header>

<!-- Services-->
<section class="page-section" id="myInfo">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-lg-8 col-xl-6 text-center">
                <h2 class="mt-0">회원정보</h2>
                <hr class="divider" />
            </div>
        </div>
        <div class="row gx-4 gx-lg-5 justify-content-center mb-5">
            <div class="col-lg-6">
                <form id="joinForm" data-sb-form-api-token="API_TOKEN">

                    <!-- Name input-->
                    <div class="form-floating mb-3">
                        <h6 class="mt-0"> NAME </h6> <input class="form-control" id="name" type="text" disabled/>
                    </div>

                    <!-- ID input-->
                    <div class="form-floating mb-3">
                        <h6 class="mt-0"> I D </h6><input class="form-control" id="identity" type="text" disabled/><!--placeholder="ID" data-sb-validations="required" -->
                    </div>

                    <!-- ID DoubleCheck input-->
                    <div class="form-floating mb-3" id="idCheckDiv" style="display:none" >
                        <input class="btn btn-primary btn-xl" type="button" id="idDoubleCheck" value="ID중복확인"/>
                    </div>

                    <!-- birth input-->
                    <div class="form-floating mb-3">
                        <h6 class="mt-0"> BIRTH </h6><input class="form-control" id="birth"  disabled/><!--placeholder="ID" data-sb-validations="required" -->
                    </div>

                    <!-- Password input-->
                    <div class="form-floating mb-3" id="pwDiv" style="display:none" >
                        <h6 class="mt-0"> NEW PW </h6><input class="form-control" id="password" type="password" placeholder="Password" data-sb-validations="required"/>
                    </div>

                    <!-- Password confirm input-->
                    <div class="form-floating mb-3" id="pwConfirmDiv" style="display:none" >
                        <h6 class="mt-0"> PW CONFIRM</h6><input class="form-control" id="confirmPassword" type="password" /><!--placeholder="Password-Check" data-sb-validations="required" -->
                    </div>

                    <div >
                        <div class="text-center mb-3">
                            <div class="fw-bolder" id="idCheckResultMsg" style="color:tomato; font-size:18px;"></div>
                        </div>
                    </div>

                    <!--수정창 오픈-->
                    <div class="d-grid">
                        <input type="button"class="btn btn-primary btn-xl" id="changeButton" value="정보수정"/>
                    </div>
                    <!--수정저장-->
                    <div class="d-grid">
                        <input type="button"  class="btn btn-primary btn-xl" id="submitButton" value="완료" style="display:none"/>
                    </div>
                    <!--수정취소-->
                    <div class="d-grid">
                        <input type="button"class="btn btn-primary btn-xl" id="changeCancelButton"  style="display:none" value="수정취소" onClick="window.location.reload()"/>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>


<section class="page-section" id="bookStatus">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-lg-8 col-xl-6 text-center">
                <h2 class="mt-0">예약현황</h2>
                <hr class="divider" />
            </div>
            <div>
                //여기에 뒷단에서 내 아이디가 예약한 세미나실 데이터 가져오기 로직 짠다. javascript로 짠다. 예약 취소버튼 만든다.
            </div>
        </div>
    </div>
</section>

<!--회원조회 모달-->
<div class="modal-wrapper" style="display: none;">
    <div class="modal-new">
        <div class="modal-title">사용자 확인</div>
        <div>
            I  D  <input class="form-control" type="text" id="checkId"/>
            P W  <input class="form-control" type="password" id="checkPw"/>
        </div>
        </br>
        <div class="fw-bolder" id="checkMsg" style="color:#1a1e21;"></div>
        </br>
        <div class="close-wrapper">
            <button class="btn btn-light btn-xl" id="IdPwConfirm" onclick="IdPwConfirm()">확인</button>&nbsp&nbsp
            <button class="btn btn-light btn-xl" id="close">취소</button>
        </div>
    </div>
</div>

<!-- Footer-->
<footer class="bg-light py-5">
    <div class="container px-4 px-lg-5"><div class="small text-center text-muted">Copyright &copy; 2022 - isjiji</div></div>
</footer>

<!-- Bootstrap core JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- SimpleLightbox plugin JS-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/SimpleLightbox/2.1.0/simpleLightbox.min.js"></script>
<!-- Core theme JS-->
<script src="js/scripts.js"></script>
<script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>

<script>
    let dbName = "";
    let dbIdentity = "";
    let dbBirth = "";


    const changeButton = document.querySelector("#changeButton");
    const submitButton = document.querySelector("#submitButton");
    const name = document.querySelector("#name");
    const identity = document.querySelector("#identity");
    const birth = document.querySelector("#birth");
    const password = document.querySelector("#password");
    const confirmPassword = document.querySelector("#confirmPassword");

    const idCheckDiv = document.querySelector("#idCheckDiv");
    const pwDiv = document.querySelector("#pwDiv");
    const pwConfirmDiv = document.querySelector("#pwConfirmDiv");
    const changeCancelButton = document.querySelector("#changeCancelButton");
    const close = document.getElementById("close");
    const modal = document.querySelector(".modal-wrapper");
    const checkId = document.querySelector("#checkId");
    const checkPw = document.querySelector("#checkPw");
    const checkMsg = document.querySelector("#checkMsg");

    const idCheckResultMsg = document.querySelector("#idCheckResultMsg");

    <!--const  = document.querySelector("#");-->

    <!--세션체크-->
    let sessionStatus = null;
        (function(){
            let xhr = new XMLHttpRequest();
            xhr.open('Get', "/member/sessionCheck"
                    ,true);
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.send();
            xhr.onreadystatechange = () => {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    // 데이터 확인
                    sessionStatus = xhr.responseText;
                    if(sessionStatus==-1){
                        location.href="/index.html";
                    }else if(sessionStatus==0){
                        retrieve();
                    }
                }
            }
    })();

    <!--초기회원정보화면-->
    function retrieve(){
        if(sessionStatus==0){
            let xhr = new XMLHttpRequest();
                xhr.open('POST', "/myPage/retrieve?"
                        ,true);
                xhr.setRequestHeader('Accept', 'application/json');
                xhr.send();
                xhr.onreadystatechange = () => {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        // 데이터 확인
                        let txt = xhr.responseText;
                        txt = JSON.parse(txt);

                        alert(txt.name);
                        dbName=txt.name;
                        dbIdentity=txt.id;
                        dbBirth=txt.birthday;

                        name.value=dbName;
                        identity.value=dbIdentity;
                        birth.value=dbBirth;
                    }
                }
        }
    }


    <!--회원정보수정시 회원인증-->
    function IdPwConfirm(){
        if(checkPw.value.trim()==null||checkPw.value.trim()=="" ||
           checkId.value.trim()==null||checkId.value.trim()==""
        ){
           checkMsg.innerHTML = "※ ID 혹은 비밀번호를 입력해주세요";
           return;
        }else{
           let loginData = {"password":checkPw.value, "id":checkId.value}
           loginData = JSON.stringify(loginData);

           let xhr = new XMLHttpRequest();
           xhr.open('POST', "/member/login?"
               + "loginData=" + encodeURI(loginData)
               ,true);
           xhr.setRequestHeader('Accept', 'application/json');
           xhr.send();
           xhr.onreadystatechange = () => {
               if (xhr.readyState == 4 && xhr.status == 200) {
                   // 데이터 확인
                   let txt = xhr.responseText;
                   txt = JSON.parse(txt);
                   console.log(txt.errorCode);
                   console.log(txt.errorMsg);
                   if (txt.errorCode == -1 || txt.errorCode == -2 ) {
                      checkMsg.innerHTML = "※ " + txt.errorMsg;
                       return;
                   } else {
                      modal.style.display = "none";
                      name.disabled=false;
                      identity.disabled=false;
                      birth.disabled=false;
                      password.style.display="block";
                      idCheckDiv.style.display="block";
                      pwDiv.style.display="block";
                      pwConfirmDiv.style.display="block";
                      changeButton.style.display="none";
                      submitButton.style.display="block";
                      changeCancelButton.display="block";
                      checkPw.value="";
                      checkId.value="";
                      checkMsg.innerHTML="";
                      name.value = dbName;
                      identity.value  = dbIdentity;
                      birth.value  = dbBirth;

                   }
               }
           }
        }
    }

    <!--회원인증창 닫기-->
    close.onclick = () => {
        modal.style.display = "none";
        checkPw.value="";
        checkId.value="";
        checkMsg.innerHTML="";
    };

    <!--회원정보 수정 -->
    changeButton.addEventListener('click',()=>{
        modal.style.display = "flex";
    <!--클릭하면 ID PW 체크 하게 만들기 그 다음에 아래 로직 수행-->
    });

    <!--아이디 더블체크-->
    idDoubleCheck.addEventListener('click', () => {
        if(identity.value.trim()==""||identity.value.trim()==null){
            idCheckResultMsg.innerHTML="ID를 입력해주세요";
            return;
        }
        let xhr = new XMLHttpRequest();
        xhr.open('Get', "/member/idDoubleCheck?"
            + "identity=" + identity.value
            ,true);
        xhr.setRequestHeader('Accept', 'application/json');
        xhr.send();
        xhr.onreadystatechange = () => {
            if (xhr.readyState == 4 && xhr.status == 200) {
                // 데이터 확인
                let txt = xhr.responseText;
                txt = JSON.parse(txt);
                if (txt.errorCode < 0) {
                    idCheckResultMsg.innerHTML="※ 이미 사용중인 아이디입니다.";
                    idDoubleCheck.value="ID중복확인";
                    return;
                }
                idCheckResultMsg.innerHTML="※ 사용 가능한 아이디입니다.";
                idDoubleCheck.value="사용가능";
            }
        }
    });
    let changeName="" ;
    let changeIdentity="";
    let changeBirth="";
    let changePassword="";
    let changeConfirmTxt="회원님의 ";

    submitButton.addEventListener('click',()=>{
        if(name.value.trim()!=dbName){
            changeName=name.value.trim();
            changeConfirmTxt+="이름 ";
        }if(identity.value.trim()!=dbIdentity){
            if(idDoubleCheck.value=="사용가능"){
                changeIdentity=identity.value.trim();
                changeConfirmTxt+="아이디 ";
            }else{
                alert("변경 아이디 중복체크가 필요합니다.");
                return;
            }
        }if(birth.value.trim()!=dbBirth){
            if(isNaN(birth.value)){
                alert("숫자만 입력가능합니다.");
                return;
            }else {
                changeBirth=birth.value.trim();
                changeConfirmTxt+="생일 ";
            }
        }if(password.value.trim()!=null || password.value.trim()!="" || confirmPassword.value.trim()!=null || confirmPassword.value.trim()!=""){
            if(password.value==confirmPassword.value){
                changePassword=password.value.trim();
                changeConfirmTxt+="비밀번호 ";
            }else{
                alert("입력한 비밀번호를 확인해주세요.");
                return;
            }
        }
       alert(changeConfirmTxt+"정보를 변경하시겠습니까?");
       let changeInfo = {"birth":changeBirth,"password":changePassword,"id":changeIdentity,"name":changeName} //데이터 추가하기
           changeInfo = JSON.stringify(changeInfo);

           let xhr = new XMLHttpRequest();
           xhr.open('POST',  "/myPage/changeInfo?"
               + "changeInfo=" + encodeURI(changeInfo)
               ,true);
           xhr.setRequestHeader('Accept', 'application/json');
           xhr.send();
           xhr.onreadystatechange = () => {
               if (xhr.readyState == 4 && xhr.status == 200) {
                   // 데이터 확인
                   let txt = xhr.responseText;
                   txt = JSON.parse(txt);
                   console.log(txt.errorCode);
                   console.log(txt.errorMsg);
                   if (txt.errorCode == -1 || txt.errorCode == -2 ) {
                      alert(errMsg);
                       return;
                   } else {
                       alert("변경이 완료되었습니다.");
                   }
        name.disabled=true;
        identity.disabled=true;
        birth.disabled=true;
        password.style.display="none";
        idCheckDiv.style.display="none";
        pwDiv.style.display="none";
        pwConfirmDiv.style.display="none";
        changeButton.style.display="block";
        submitButton.style.display="none";
        changeCancelButton.display="none";
        name.value = dbName;
        identity.value  = dbIdentity
        birth.value  = dbBirth;
        idDoubleCheck.value="ID중복확인";
        password.value="";
        confirmPassword.value="";
        idCheckResultMsg.innerHTML="";

               }
           }
    });



    <!--세미나실 예약확인 창 -->
    function sendRoomId(roomId){
                    swal({
                          title : '세미나실 예약'
                        , text : 'ヽ(✿ﾟ▽ﾟ)ノ \n'
                                  +bookingDate.value+' '+bookingTime.value+'~'+bookingTime.value+1
                                  +'\n 해당 일시에 '+roomId.value+'호 세미나실을 예약하시겠습니까?'
                        , button : '확인'
                        , buttonColor : 'tomato'
                    }).then(function() {
                        sendBookdata(roomId.value); <!--예약자, 예약방, 예약시간, 예약날짜 DB로 보내서 insert해주기-->
                    });
        }
    <!--세미나실 예약-->
    function sendBookdata(roomId){

        let insertBookData ={"roomId":roomId,"bookingTime":bookingTime.value,"bookingDate":bookingDate.value};
        insertBookData=JSON.stringify(insertBookData);

        let xhr = new XMLHttpRequest();
        xhr.open('Get'
                  , "/book/roomBook?insertBookData="+encodeURI(insertBookData)
                      , true);
        xhr.setRequestHeader('Accept','application/json');
        xhr.send();
        xhr.onreadystatechange = () => {
            if(xhr.readyState == 4 && xhr.status == 200){
                let txt = xhr.responseText;
                txt = JSON.parse(txt);
                alert("뚄꾠!!");
            }
        }


    }
    /*로그아웃*/
    function logoutButton(){
        let xhr = new XMLHttpRequest();
        xhr.open('Get', "/member/logout"
            ,true);
        xhr.setRequestHeader('Accept', 'application/json');
        xhr.send();
        xhr.onreadystatechange = () => {
            if (xhr.readyState == 4 && xhr.status == 200) {
                // 데이터 확인
                let txt = xhr.responseText;
                console.log("로그아웃되었습니다.");
                location.href="/index.html";
            }
        }
    }
</script>
</body>
</html>
